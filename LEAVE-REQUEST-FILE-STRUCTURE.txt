LEAVE REQUEST SYSTEM - FILE STRUCTURE & DEPENDENCIES

â”œâ”€â”€ SERVICES (lib/services/)
â”‚   â”œâ”€â”€ leave-service.ts â­ CORE
â”‚   â”‚   â”œâ”€ Exports: LeaveRequest, LeaveRequestFormData, LeaveRequestStats
â”‚   â”‚   â”œâ”€ Key Fns: getAllLeaveRequests, createLeaveRequestServer, updateLeaveRequestStatus
â”‚   â”‚   â””â”€ Calls: Supabase, audit-service, error-logger
â”‚   â”‚
â”‚   â”œâ”€â”€ leave-eligibility-service.ts ğŸ§  COMPLEX LOGIC
â”‚   â”‚   â”œâ”€ Exports: CrewRequirements, CrewAvailability, LeaveEligibilityCheck, ConflictingRequest
â”‚   â”‚   â”œâ”€ Key Fns: checkLeaveEligibility, calculateCrewAvailability, getConflictingPendingRequests
â”‚   â”‚   â””â”€ Calls: Supabase, date-fns
â”‚   â”‚
â”‚   â””â”€â”€ pilot-leave-service.ts ğŸ‘¤ PILOT WRAPPER
â”‚       â”œâ”€ Exports: ServiceResponse
â”‚       â”œâ”€ Key Fns: submitPilotLeaveRequest, getCurrentPilotLeaveRequests, cancelPilotLeaveRequest
â”‚       â””â”€ Calls: leave-service, pilot-portal-service, error-logger
â”‚
â”œâ”€â”€ VALIDATION (lib/validations/)
â”‚   â”œâ”€â”€ leave-validation.ts ğŸ“‹ ADMIN SCHEMAS
â”‚   â”‚   â”œâ”€ Exports: LeaveRequestCreateSchema, LeaveRequestUpdateSchema, etc.
â”‚   â”‚   â””â”€ Date Format: ISO datetime (e.g., "2025-10-26T15:30:00.000Z")
â”‚   â”‚
â”‚   â””â”€â”€ pilot-leave-schema.ts ğŸ“‹ PILOT SCHEMAS
â”‚       â”œâ”€ Exports: PilotLeaveRequestSchema, PilotLeaveCancelSchema
â”‚       â”œâ”€ Date Format: YYYY-MM-DD (e.g., "2025-10-26")
â”‚       â””â”€ Helpers: isLateRequest(), getTodayISO()
â”‚
â”œâ”€â”€ API ROUTES (app/api/)
â”‚   â”œâ”€â”€ ADMIN ROUTES
â”‚   â”‚   â”œâ”€â”€ leave-requests/route.ts
â”‚   â”‚   â”‚   â”œâ”€ GET: getAllLeaveRequests â†’ List with filters
â”‚   â”‚   â”‚   â””â”€ POST: createLeaveRequestServer â†’ Create new
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ leave-requests/[id]/review/route.ts
â”‚   â”‚       â””â”€ PUT: updateLeaveRequestStatus â†’ Approve/deny
â”‚   â”‚
â”‚   â”œâ”€â”€ PILOT PORTAL ROUTES
â”‚   â”‚   â””â”€â”€ portal/leave-requests/route.ts
â”‚   â”‚       â”œâ”€ POST: submitPilotLeaveRequest â†’ Create new
â”‚   â”‚       â”œâ”€ GET: getCurrentPilotLeaveRequests â†’ List mine
â”‚   â”‚       â””â”€ DELETE: cancelPilotLeaveRequest â†’ Cancel pending
â”‚   â”‚
â”‚   â””â”€â”€ LEGACY PILOT ROUTES
â”‚       â””â”€â”€ pilot/leave/route.ts
â”‚           â”œâ”€ GET: getCurrentPilotLeaveRequests
â”‚           â””â”€ POST: submitPilotLeaveRequest
â”‚
â”œâ”€â”€ PAGES (app/)
â”‚   â”œâ”€â”€ ADMIN DASHBOARD PAGES
â”‚   â”‚   â”œâ”€â”€ dashboard/leave/page.tsx â­ MAIN PAGE
â”‚   â”‚   â”‚   â”œâ”€ Server Component
â”‚   â”‚   â”‚   â”œâ”€ Fetches: getAllLeaveRequests()
â”‚   â”‚   â”‚   â”œâ”€ Renders: Stats + <LeaveRequestsClient>
â”‚   â”‚   â”‚   â””â”€ Actions: "Submit Leave Request" button
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ dashboard/leave/new/page.tsx
â”‚   â”‚       â”œâ”€ Server Component
â”‚   â”‚       â””â”€ Renders: <LeaveRequestForm> (create mode)
â”‚   â”‚
â”‚   â””â”€â”€ PILOT PORTAL PAGES
â”‚       â”œâ”€â”€ portal/(protected)/leave-requests/page.tsx
â”‚       â”‚   â”œâ”€ Server Component
â”‚       â”‚   â”œâ”€ Fetches: getCurrentPilotLeaveRequests()
â”‚       â”‚   â””â”€ Renders: Request list with filters
â”‚       â”‚
â”‚       â””â”€â”€ portal/(protected)/leave-requests/new/page.tsx
â”‚           â”œâ”€ Server Component
â”‚           â””â”€ Renders: <LeaveRequestForm> (pilot mode)
â”‚
â”œâ”€â”€ COMPONENTS (components/)
â”‚   â”œâ”€â”€ LEAVE MANAGEMENT UI
â”‚   â”‚   â”œâ”€â”€ leave/leave-requests-client.tsx ğŸ”„ CLIENT
â”‚   â”‚   â”‚   â”œâ”€ Filters: By roster period
â”‚   â”‚   â”‚   â”œâ”€ Groups: By type â†’ role â†’ sort by date
â”‚   â”‚   â”‚   â”œâ”€ Stats: Calculated in real-time
â”‚   â”‚   â”‚   â””â”€ Modal: <LeaveReviewModal>
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ leave/leave-request-group.tsx ğŸ”„ CLIENT
â”‚   â”‚   â”‚   â”œâ”€ Expandable: Yes (click to toggle)
â”‚   â”‚   â”‚   â”œâ”€ Stats: Total, pending, approved, denied, days
â”‚   â”‚   â”‚   â””â”€ Sorting: By start date within group
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ leave/leave-review-modal.tsx ğŸ”„ CLIENT
â”‚   â”‚       â”œâ”€ Dialog: Approve/deny interface
â”‚   â”‚       â”œâ”€ Shows: Request details + crew impact
â”‚   â”‚       â”œâ”€ Seniority: Comparison if multiple requesting
â”‚   â”‚       â””â”€ Action: PUT /api/leave-requests/[id]/review
â”‚   â”‚
â”‚   â””â”€â”€ FORM COMPONENTS
â”‚       â”œâ”€â”€ forms/leave-request-form.tsx ğŸ”„ CLIENT (ADMIN)
â”‚       â”‚   â”œâ”€ Mode: Create or Edit
â”‚       â”‚   â”œâ”€ Fields: Pilot select, type, dates, reason, method
â”‚       â”‚   â”œâ”€ Validation: LeaveRequestCreateSchema
â”‚       â”‚   â””â”€ Calls: POST /api/leave-requests
â”‚       â”‚
â”‚       â””â”€â”€ portal/leave-request-form.tsx ğŸ”„ CLIENT (PILOT)
â”‚           â”œâ”€ Mode: Create only
â”‚           â”œâ”€ Fields: Type, dates (YYYY-MM-DD), reason
â”‚           â”œâ”€ Validation: PilotLeaveRequestSchema
â”‚           â””â”€ Calls: POST /api/portal/leave-requests
â”‚
â”œâ”€â”€ TYPES (types/)
â”‚   â””â”€â”€ supabase.ts
â”‚       â””â”€ Generated types from Supabase schema
â”‚           â”œâ”€ leave_requests table type definitions
â”‚           â””â”€ Related table types (pilots, an_users, etc.)
â”‚
â””â”€â”€ DATABASE (supabase/)
    â””â”€â”€ migrations/
        â””â”€ Contains: leave_requests table definition
            â”œâ”€ Columns: All fields from LeaveRequest interface
            â”œâ”€ Indexes: pilot_id, status, created_at, etc.
            â””â”€ Constraints: UNIQUE(pilot_id, start_date, end_date)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

DATA FLOW EXAMPLES

1. ADMIN CREATE REQUEST
   Form â†’ POST /api/leave-requests â†’ LeaveRequestCreateSchema.parse()
   â†’ createLeaveRequestServer() â†’ Database INSERT â†’ Audit Log â†’ Response

2. PILOT SUBMIT REQUEST
   Form â†’ POST /api/portal/leave-requests â†’ PilotLeaveRequestSchema.parse()
   â†’ submitPilotLeaveRequest() â†’ leave-service.createLeaveRequestServer()
   â†’ Database INSERT â†’ Response

3. ADMIN REVIEWS REQUEST
   Dashboard â†’ <LeaveReviewModal> â†’ PUT /api/leave-requests/[id]/review
   â†’ updateLeaveRequestStatus() â†’ RPC approve_leave_request()
   â†’ Atomic: Status UPDATE + Audit Log â†’ Response

4. ELIGIBILITY CHECK (Background)
   checkLeaveEligibility() â†’ calculateCrewAvailability() + getConflictingPendingRequests()
   â†’ Determines: isEligible, recommendation, conflicts â†’ LeaveEligibilityCheck

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

DEPENDENCY GRAPH

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UI (Components)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LeaveRequestForm â†’ POST /api/leave-requests                 â”‚
â”‚ LeaveRequestsClient â†’ LeaveRequestGroup â†’ LeaveReviewModal â”‚
â”‚ Portal Forms â†’ POST /api/portal/leave-requests              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               API Routes (Validation)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LeaveRequestCreateSchema (admin)                            â”‚
â”‚ PilotLeaveRequestSchema (pilot)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Service Layer (Business Logic)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ leave-service.ts                                            â”‚
â”‚ â”œâ”€ createLeaveRequestServer()                              â”‚
â”‚ â”œâ”€ updateLeaveRequestStatus()                              â”‚
â”‚ â””â”€ checkLeaveConflicts()                                   â”‚
â”‚                                                             â”‚
â”‚ leave-eligibility-service.ts                               â”‚
â”‚ â”œâ”€ checkLeaveEligibility()                                 â”‚
â”‚ â”œâ”€ calculateCrewAvailability()                             â”‚
â”‚ â””â”€ getConflictingPendingRequests()                         â”‚
â”‚                                                             â”‚
â”‚ pilot-leave-service.ts                                     â”‚
â”‚ â”œâ”€ submitPilotLeaveRequest()                               â”‚
â”‚ â””â”€ getCurrentPilotLeaveRequests()                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Database & External Services                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Supabase (PostgreSQL)                                       â”‚
â”‚ â”œâ”€ leave_requests table                                    â”‚
â”‚ â”œâ”€ pilots table (joined)                                   â”‚
â”‚ â””â”€ an_users table (joined)                                 â”‚
â”‚                                                             â”‚
â”‚ Audit Service (audit-service.ts)                           â”‚
â”‚ â”œâ”€ createAuditLog() - called on all CRUD ops              â”‚
â”‚                                                             â”‚
â”‚ Error Logger (error-logger.ts)                             â”‚
â”‚ â””â”€ logError() - called on exceptions                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

KEY PATTERNS

âœ“ Service Layer Pattern: All DB ops through services
âœ“ Validation Pattern: Zod schemas at API boundary
âœ“ Error Handling: Custom error types (DuplicateLeaveRequestError)
âœ“ Audit Logging: Automatic logging via service layer
âœ“ Type Safety: Full TypeScript with inference
âœ“ Component Pattern: Server + Client components
âœ“ Form Pattern: React Hook Form + Zod
âœ“ State Management: Optimistic updates in components
âœ“ Authorization: Ownership checks in services
âœ“ Data Normalization: Single source of truth in database

