# PWA Completion Specification

**Feature**: Complete Progressive Web App Support for Fleet Management V2
**Created**: 2025-10-22
**Status**: In Progress
**Priority**: HIGH (Phase 1 - Critical Infrastructure)
**Estimated Effort**: 2 hours

---

## Executive Summary

Fleet Management V2 has **partial PWA implementation** using Serwist (@serwist/next v9.2.1). This specification completes the remaining components to achieve full offline functionality and mobile installation support.

### Current State
✅ Serwist installed and configured
✅ Service worker source (app/sw.ts) with custom caching
✅ Manifest file (public/manifest.json) with shortcuts
✅ Next.js configuration (withSerwist wrapper)
❌ **Missing**: Offline fallback page
❌ **Missing**: OfflineIndicator component

### Target State
✅ Complete offline experience
✅ Visual feedback for connectivity status
✅ Mobile installation support
✅ Air Niugini brand compliance

---

## 1. Problem Statement

When users lose internet connectivity, the service worker redirects to `/offline`, but this route doesn't exist, resulting in a 404 error. Additionally, users have no visual indication of their connection status during normal operation.

**Impact**: Poor user experience, especially for pilots in remote areas with unreliable connectivity.

---

## 2. Requirements

### Functional Requirements

**FR1: Offline Fallback Page**
- MUST display when user is offline and navigates
- MUST show clear "You're Offline" message
- MUST provide troubleshooting steps
- MUST have "Try Again" button to reload
- MUST auto-reload when connection restored
- MUST match Air Niugini brand colors

**FR2: Offline Indicator Component**
- MUST show banner when connection is lost
- MUST auto-hide when connection restored
- MUST show "Back Online" confirmation (5 seconds)
- MUST be non-intrusive (top banner)
- MUST use framer-motion for smooth animations

**FR3: Layout Integration**
- MUST add OfflineIndicator to root layout
- MUST NOT interfere with navigation
- MUST work on all pages (dashboard, portal)

### Non-Functional Requirements

**NFR1: Performance**
- Offline page MUST load instantly from cache
- OfflineIndicator MUST detect status change within 1 second

**NFR2: Accessibility**
- MUST use proper ARIA labels (role="alert", aria-live)
- MUST support keyboard navigation
- MUST have clear visual contrast

**NFR3: Brand Consistency**
- MUST use Air Niugini Red (#E4002B) or current theme
- MUST match existing UI patterns
- MUST use fleet management styling

---

## 3. Technical Design

### Architecture

```
fleet-management-v2/
├── app/
│   ├── sw.ts                          # ✅ Exists (service worker source)
│   ├── offline/                       # ❌ CREATE
│   │   └── page.tsx                   # Offline fallback page
│   └── layout.tsx                     # ✅ UPDATE (add OfflineIndicator)
│
├── components/
│   └── offline/                       # ❌ CREATE
│       └── OfflineIndicator.tsx       # Connection status banner
│
├── public/
│   ├── sw.js                          # ✅ Auto-generated by Serwist
│   └── manifest.json                  # ✅ Exists
│
└── next.config.js                     # ✅ Exists (withSerwist configured)
```

### 3.1 Offline Fallback Page

**File**: `app/offline/page.tsx`

**Features**:
- Client component (`'use client'`)
- Auto-reload on connection restoration
- Visual hierarchy: Header → Status → Troubleshooting → Actions
- Responsive design (mobile-first)
- Accessibility compliant

**Key Components**:
```tsx
export default function Offline() {
  useEffect(() => {
    // Auto-reload when connection restored
    const handleOnline = () => {
      setTimeout(() => window.location.reload(), 1000);
    };
    window.addEventListener('online', handleOnline);
    return () => window.removeEventListener('online', handleOnline);
  }, []);

  return (
    <div className="min-h-screen flex items-center justify-center">
      {/* Offline UI */}
    </div>
  );
}
```

**Design Elements**:
- Header with WifiOff icon
- Connection status alert box
- Numbered troubleshooting steps (1-4)
- Action buttons: "Try Again", "Go to Dashboard"
- Auto-retry notice
- Support contact information

### 3.2 Offline Indicator Component

**File**: `components/offline/OfflineIndicator.tsx`

**Features**:
- Client component with real-time status
- Two states: Offline (red), Back Online (green)
- Framer Motion animations (slide from top)
- Auto-hide "Back Online" after 5 seconds
- Compact design (non-intrusive)

**Key Components**:
```tsx
export function OfflineIndicator() {
  const [isOnline, setIsOnline] = useState(true);
  const [wasOffline, setWasOffline] = useState(false);

  useEffect(() => {
    setIsOnline(navigator.onLine);

    const handleOnline = () => {
      setIsOnline(true);
      setWasOffline(true);
      setTimeout(() => setWasOffline(false), 5000);
    };

    const handleOffline = () => setIsOnline(false);

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  return (
    <AnimatePresence mode="wait">
      {/* Offline/Online banners */}
    </AnimatePresence>
  );
}
```

**States**:
1. **Offline**: Red banner with WifiOff icon, "You're Offline" message, Retry button
2. **Back Online**: Green banner with Wifi icon, "Back Online" message, auto-hide after 5s
3. **Online**: No banner (hidden)

---

## 4. Implementation Plan

### Phase 1: Create Offline Page (30 min)
1. Create `app/offline/page.tsx`
2. Port design from air-niugini-pms (adapt colors for fleet-management-v2)
3. Update Air Niugini branding to generic Fleet Management
4. Add auto-reload listener
5. Test offline navigation

### Phase 2: Create OfflineIndicator (30 min)
1. Create `components/offline/OfflineIndicator.tsx`
2. Implement offline/online detection
3. Add framer-motion animations
4. Add ARIA labels for accessibility
5. Test with DevTools Network throttling

### Phase 3: Integration (15 min)
1. Import OfflineIndicator in `app/layout.tsx`
2. Position above main content (fixed top-0)
3. Verify z-index stacking
4. Test on dashboard and portal routes

### Phase 4: Testing & Validation (45 min)
1. **Offline Mode Testing**
   - DevTools → Network → Offline
   - Navigate to /offline manually
   - Navigate while offline (should fallback)
   - Verify auto-reload on reconnect

2. **OfflineIndicator Testing**
   - Toggle offline/online repeatedly
   - Verify animations smooth
   - Check 5-second auto-hide works
   - Test retry button functionality

3. **Mobile Testing**
   - iOS Safari (Add to Home Screen)
   - Android Chrome (Install prompt)
   - Verify offline mode on installed app
   - Check push notifications work

4. **Accessibility Testing**
   - Screen reader announces offline status
   - Keyboard navigation works
   - Color contrast meets WCAG AA
   - ARIA labels present

---

## 5. Success Criteria

### Must Have (P0)
- [ ] Offline page displays when user goes offline
- [ ] Auto-reload works when connection restored
- [ ] OfflineIndicator shows/hides correctly
- [ ] All PWA criteria met (Lighthouse PWA score ≥90)
- [ ] Mobile installation works (iOS + Android)

### Should Have (P1)
- [ ] Framer Motion animations smooth
- [ ] Brand colors match theme
- [ ] Troubleshooting steps helpful
- [ ] Support contact linked

### Nice to Have (P2)
- [ ] OfflineBadge variant for compact spaces
- [ ] Offline data queue (sync when reconnected)
- [ ] Background sync for pending actions

---

## 6. Testing Strategy

### Unit Tests (N/A)
- No unit tests for these components (E2E sufficient)

### E2E Tests (Playwright)
```typescript
// e2e/pwa.spec.ts
test.describe('PWA Offline Functionality', () => {
  test('should display offline page when offline', async ({ page, context }) => {
    await context.setOffline(true);
    await page.goto('/dashboard/pilots');
    await expect(page.getByRole('heading', { name: 'No Internet Connection' })).toBeVisible();
  });

  test('should show offline indicator when connection lost', async ({ page }) => {
    await page.goto('/dashboard');
    await page.evaluate(() => window.dispatchEvent(new Event('offline')));
    await expect(page.getByText("You're Offline")).toBeVisible();
  });
});
```

### Manual Testing Checklist
- [ ] Install app on iOS device
- [ ] Install app on Android device
- [ ] Test offline mode in installed app
- [ ] Verify service worker caching
- [ ] Check manifest shortcuts work
- [ ] Test push notifications (if applicable)

---

## 7. Dependencies

### External Dependencies
- ✅ @serwist/next (v9.2.1) - Already installed
- ✅ framer-motion (12.23.22) - Already installed (check package.json)
- ✅ lucide-react (0.546.0) - Already installed

### Internal Dependencies
- ✅ Service worker (app/sw.ts)
- ✅ Manifest (public/manifest.json)
- ✅ Next.js config (withSerwist)

### Icon Assets
- ⚠️ Need to verify icon files exist:
  - public/icon-192.png
  - public/icon-512.png
  - public/screenshot-mobile.png
  - public/screenshot-desktop.png

---

## 8. Risks & Mitigations

### Risk 1: Service Worker Caching Issues
**Impact**: Medium
**Probability**: Low
**Mitigation**: Serwist handles cache invalidation automatically. `skipWaiting: true` ensures immediate updates.

### Risk 2: iOS Safari Quirks
**Impact**: Medium
**Probability**: Medium
**Mitigation**: Test on actual iOS device. Safari has limited PWA support compared to Android.

### Risk 3: Framer Motion Bundle Size
**Impact**: Low
**Probability**: Low
**Mitigation**: Framer Motion already installed. Animations are lightweight.

---

## 9. Rollout Plan

### Development
1. Create feature branch: `feature/pwa-completion`
2. Implement offline page
3. Implement OfflineIndicator
4. Test locally with DevTools offline mode

### Staging
1. Deploy to Vercel preview
2. Test on mobile devices
3. Verify service worker registration
4. Check Lighthouse PWA score

### Production
1. Merge to main
2. Deploy to production
3. Monitor error logs
4. Announce PWA installation to users

---

## 10. Documentation Updates

### Files to Update
- [x] CLAUDE.md - Already has PWA section
- [ ] README.md - Add PWA installation instructions
- [ ] .specify/PRODUCTION-READINESS-FINAL.md - Update PWA status

### User Documentation
- Create "Install the App" guide
- Create "Offline Mode" FAQ
- Update admin guide with PWA troubleshooting

---

## 11. Acceptance Criteria

**Definition of Done:**
1. ✅ Offline page created and functional
2. ✅ OfflineIndicator component created
3. ✅ Integrated into root layout
4. ✅ Service worker configuration verified
5. ✅ Lighthouse PWA score ≥90
6. ✅ Manual testing on iOS and Android
7. ✅ E2E tests pass
8. ✅ Documentation updated
9. ✅ Code reviewed
10. ✅ Deployed to production

---

## 12. Reference Implementation

**Source**: `/Users/skycruzer/Desktop/Fleet Office Management/air-niugini-pms/`

**Files to Reference**:
- `src/app/offline.tsx` - Offline page design
- `src/components/offline/OfflineIndicator.tsx` - Indicator component
- `public/manifest.json` - Manifest structure

**Adaptations Required**:
- Change Air Niugini Red (#E4002B) to current theme color
- Update "Air Niugini Pilot Management System" to "Fleet Management V2"
- Use Next.js 15 patterns (Server Components where possible)
- Match existing component library (shadcn/ui)

---

## 13. Next Steps

1. **Immediate**: Create offline page and OfflineIndicator
2. **Short-term**: Test on mobile devices
3. **Medium-term**: Add background sync for pending actions
4. **Long-term**: Implement offline data queue

---

**Specification Approved**: Pending
**Implementation Start**: 2025-10-22
**Target Completion**: 2025-10-22 (same day)
**Assigned To**: Claude Code

**SpecKit Workflow Status**: Phase 2 - Implementation
**Next Phase**: Implementation → Testing → Deployment
